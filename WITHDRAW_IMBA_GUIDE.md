# Гайд по системе вывода Imba Coin → Telegram Stars

## Обзор системы

Реализована система ручного перевода Imba Coin через Telegram Stars с комиссией 10% и подробной статистикой для админа.

## Особенности системы

### ✅ Комиссия 10%
- При выводе 100 IC пользователь получит 90 IC
- Комиссия 10 IC остается у владельца игры
- Комиссия рассчитывается автоматически

### ✅ Ручной перевод через рабочий аккаунт
- Админ одобряет заявку в админке
- Ручной перевод звёзд через Telegram UI
- Не требует настройки Business Connection

### ✅ Подробная статистика для админа
- Количество игр пользователя
- Винрейт игрока
- Прибыль/убыток владельца игры
- Общий баланс и история операций

## Компоненты системы

### 1. База данных
- **WithdrawRequest** - модель для заявок на вывод (с полем `username`)
- **Transaction** - логирование всех операций
- **User** - поле `blocked` для ограничения доступа

### 2. API Endpoints
- `POST /api/withdraw-imba` - создание заявки на вывод с комиссией
- `GET /api/admin/withdraw-requests` - список заявок с подробной статистикой
- `POST /api/admin/withdraw-requests/approve` - одобрение/отклонение заявок
- `POST /api/admin/users/balance` - управление балансом пользователей

### 3. UI Компоненты
- **BalanceModal** - модальное окно с вводом username
- **WithdrawRequestsPage** - админ-панель с подробной статистикой
- **UserDetailsPage** - управление балансом пользователей

## Алгоритм работы

### Для пользователя:
1. Открывает модальное окно баланса
2. Выбирает "Telegram Stars" как метод вывода
3. Вводит сумму (50-10,000 IC) и свой username
4. Система показывает комиссию и сумму к выплате
5. Нажимает "Запросить вывод Stars"
6. Система создает заявку и списывает средства
7. Ждет подтверждения админа

### Для админа:
1. Заходит в админку → "Заявки на вывод Imba Coin"
2. Видит список заявок "pending" с подробной статистикой:
   - Количество игр и винрейт игрока
   - Прибыль/убыток владельца игры
   - Общий баланс пользователя
   - Username для перевода
3. Нажимает "✅ Одобрить" → переходит в Telegram
4. Ручной перевод звёзд пользователю
5. Возвращается в админку и подтверждает перевод

## Статистика для админа

### В каждой заявке отображается:
- **Игр сыграно** - общее количество игр
- **Винрейт** - процент выигрышных игр
- **Текущий баланс** - текущий баланс пользователя
- **Прибыль/убыток** - прибыль владельца игры от этого игрока

### Дополнительная информация:
- **Общий баланс** - баланс + депозиты - выводы
- **Всего ставок** - сумма всех ставок игрока
- **Прибыль игрока** - общая прибыль от игр
- **Депозитов/Выводов** - история пополнений и выводов

## Настройка

### 1. Переменные окружения

Добавьте в `.env`:

```bash
# Telegram Bot
TELEGRAM_BOT_TOKEN=your_bot_token
ADMIN_BOT_TOKEN=your_admin_bot_token

# Username бота для ссылки поддержки
NEXT_PUBLIC_BOT_USERNAME=your_bot_username

# Админы
ADMIN_USER_IDS=2012133536,another_admin_id
ADMIN_USERNAMES=lowpolysnack,another_admin_username
```

### 2. Обновление базы данных

```bash
# Применить миграции
npx prisma migrate dev

# Перегенерировать клиент
npx prisma generate
```

## Ограничения и проверки

### Для пользователей:
- Минимум вывода: 50 IC
- Максимум вывода: 10,000 IC
- Комиссия: 10% от суммы вывода
- Требуется подтверждение телефона
- Нельзя иметь несколько активных заявок
- Заблокированные пользователи не могут выводить
- Username должен начинаться с @

### Для админов:
- Проверка доступа по telegramId/username
- Логирование всех действий
- Возврат средств при отклонении
- Подтверждение опасных операций

## Примеры расчетов

### Вывод 100 IC:
- Сумма вывода: 100 IC
- Комиссия (10%): 10 IC
- К выплате: 90 IC

### Вывод 1000 IC:
- Сумма вывода: 1000 IC
- Комиссия (10%): 100 IC
- К выплате: 900 IC

## Мониторинг и аналитика

### Статистика для принятия решений:
- **Прибыль владельца** - показывает, выгоден ли игрок
- **Винрейт** - помогает оценить риск
- **Общий баланс** - показывает активность пользователя
- **История операций** - помогает выявить подозрительную активность

### Логи операций:
- Создание заявок с комиссией
- Одобрение/отклонение
- Ручные переводы
- Ошибки и исключения

## Преимущества системы

### ✅ Простота настройки
- Не требует Business Connection
- Не нужны сложные API интеграции
- Работает через стандартный Telegram UI

### ✅ Контроль и безопасность
- Ручной контроль всех переводов
- Подробная статистика для принятия решений
- Возможность отклонения подозрительных заявок

### ✅ Прозрачность
- Комиссия рассчитывается автоматически
- Пользователь видит сумму к выплате
- Все операции логируются

### ✅ Гибкость
- Возможность индивидуального подхода к каждому игроку
- Учет статистики при принятии решений
- Настройка лимитов и комиссий

## Поддержка

При возникновении проблем:
1. Проверьте логи сервера
2. Убедитесь в правильности переменных окружения
3. Проверьте формат username (должен начинаться с @)
4. Убедитесь в корректности расчетов комиссии

## Дополнительные возможности

### Автоматизация:
- Уведомления о новых заявках
- Автоматические проверки подозрительной активности
- Интеграция с внешними системами аналитики

### Аналитика:
- Статистика выводов по периодам
- Анализ прибыльности игроков
- Отчеты по комиссиям и доходам 